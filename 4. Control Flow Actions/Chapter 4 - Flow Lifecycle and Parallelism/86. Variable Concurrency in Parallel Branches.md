# Power Automate Interview Prep Template

## Topic: 86. Variable Concurrency in Parallel Branches

**Last Updated:** 2023-10-26  
**Confidence:** ðŸŸ¢ Solid  
**Category:** Architecture | Patterns | Performance

## What Is It?

Variable Concurrency refers to the configuration and management of simultaneous execution pathsâ€”either through the "Concurrency Control" setting in loops or the use of visual Parallel Branchesâ€”to balance high-throughput processing with the constraints of API limits and data consistency.

**Why It Matters:**  
Without controlled concurrency, automations processing large datasets can either be too slow (sequential) or trigger "429 Too Many Requests" errors (uncontrolled parallel). In scenarios like processing 500+ invoices or syncing records to a CRM, managing concurrency is the difference between a stable production flow and one that fails due to race conditions or throttling.

## Core Concepts

- **Degree of Parallelism** - The specific number of iterations or branches allowed to execute at the exact same time (default is often 20 in loops, max 50).
- **Sequential Execution** - A concurrency setting of 1, where each action must complete before the next begins, essential for operations requiring a specific order.
- **Race Condition** - A logic error occurring when multiple parallel branches attempt to modify the same variable or resource simultaneously, leading to unpredictable results.

## Implementation

### Basic Setup

**Concurrency Control in Loops (Apply to each):**

```json
"runtimeConfiguration": {
    "concurrency": {
        "runs": 20
    }
}
```

> [!TIP]
> To enable Concurrency Control in the UI, go to the "Apply to each" settings, toggle "Concurrency Control" to On, and adjust the "Degree of Parallelism" slider.

### Advanced Configuration

**Simulating Dynamic Concurrency via Child Flows:**

```javascript
// Logic to determine batch size dynamically
// This is often handled by calculating the length of an array 
// and passing chunks to a 'Run Child Flow' action.
{
    "batchSize": "@if(greater(length(variables('Items')), 100), 50, 10)"
}
```

> [!WARNING]
> Once Concurrency Control is enabled on an "Apply to each" loop, you cannot disable it without deleting and recreating the action in some versions of the designer. Furthermore, variables (Set variable, Increment variable) inside a parallel loop will almost always result in corrupted data due to race conditions.

## Common Patterns

### Pattern 1: Fan-out / Fan-in (Visual Parallel Branches)

```
       [Trigger]
          |
    +-----+-----+
    |           |
[Branch A]   [Branch B]
    |           |
    +-----+-----+
          |
    [Join Action]
```

Used when performing independent operations that do not rely on each other (e.g., uploading a file to SharePoint and sending an Email simultaneously).

### Pattern 2: Controlled Loop Concurrency

```
[Get Items] -> [Apply to each (Concurrency: 50)] -> [Update Item]
```

Used for high-volume data processing. By setting concurrency to 50, the flow processes 50 records at once, significantly reducing total runtime compared to sequential processing.

## Performance & Limits

> [!IMPORTANT]
> **Concurrency Limits:**
> - **Apply to each:** Maximum degree of parallelism is 50.
> - **Parallel Branches:** No hard limit on the number of visual branches, but total action execution per minute limits still apply.
> - **License Requirement:** High-concurrency limits are subject to the Power Platform Request limits associated with the user's license (e.g., Per User vs. Per Flow).

**Optimization Tips:**
- Use **Select** or **Filter Array** before a loop to reduce the number of iterations.
- If you hit API limits, reduce the Degree of Parallelism rather than turning it off entirely.
- Use **Child Flows** to offload heavy processing; Child Flows have their own concurrency throttles.

**When NOT to use:**
- When updating a single variable (e.g., calculating a sum). Use the `xpath` or `item()` expressions on the array instead.
- When the order of operations is critical (e.g., Step 1 must finish before Step 2 starts).

## Interview Questions

### Beginner

**Q:** What is the default behavior of an "Apply to each" loop in Power Automate regarding concurrency?

<details>
<summary>Answer</summary>

By default, "Apply to each" loops execute sequentially (one after another) in the classic designer, but many modern environments default to a degree of parallelism of 20. 

To ensure the fastest execution, you must manually check the Settings and enable Concurrency Control if it is not already active.

</details>

---

### Intermediate

**Q:** You are using an "Apply to each" loop with Concurrency set to 20. Inside, you use "Increment Variable" to count the total price. Why is the final total often incorrect?

<details>
<summary>Approach</summary>

**Solution:**
This is a classic **Race Condition**. Because 20 iterations are running at once, multiple threads are reading the same variable value, adding to it, and writing it back at the same time. One thread overwrites the work of another.

**Correct Approach:**
Avoid variables in parallel loops. Instead, use a **Select** action to extract the prices and then use the `sum()` expression:
```json
sum(body('Select_Prices'))
```

> [!TIP]
> Always use "Compose" or "Data Operations" inside parallel loops instead of "Variables" if you need to pass data out of the loop.

**Follow-up they'll ask:** "How do you fix this if you absolutely must use a variable?"  
**Answer:** You must set the Concurrency Control to 1 (Sequential), which will significantly slow down the flow but ensure data integrity.

</details>

---

### Advanced

**Q:** How would you implement "Variable Concurrency" if the degree of parallelism needs to change based on the time of day (e.g., 50 at night, 10 during business hours)?

<details>
<summary>Solution</summary>

**Architecture:**

Power Automate does not allow dynamic adjustment of the "Degree of Parallelism" slider at runtime. To achieve this, you must use a **Pattern-based approach**:

1. **Parent Flow:** Determines the current time and calculates the "Batch Size."
2. **Batching:** Use an expression to chunk the main array into sub-arrays (batches) based on the time of day.
3. **Child Flows:** Use an "Apply to each" (Sequential) to loop through the batches, calling a Child Flow for each batch. The Child Flow itself can have internal concurrency.

**Key considerations:**

```javascript
// Chunking expression (pseudo-logic)
take(skip(variables('AllItems'), mul(iteration, batchSize)), batchSize)
```

**Trade-offs to discuss:**
- **Option A (Static):** Simple to maintain but risks throttling during peak hours.
- **Option B (Child Flows):** Highly scalable and dynamic, but increases complexity and consumes more flow runs/API calls.

</details>

## Comparison Table

| Feature | Parallel Branches (Visual) | Apply to each (Concurrency) |
|----------|-----------|-----------|
| **Best For** | Distinct, different actions | Repeating the same action on a list |
| **Max Limit** | Practical limit ~8-10 for readability | 50 (Hard limit) |
| **Data Flow** | Branches can merge back (Join) | Results usually collected via variables/arrays |
| **Configuration** | Manual "Add parallel branch" | Slider in Settings |

## Real Example

> [!NOTE]
> **Problem:** A client needed to sync 5,000 records from SQL to Dataverse daily. Sequentially, this took 4 hours, often timing out the connection.  
> **Solution:** Enabled Concurrency Control on the "Apply to each" loop with a Degree of Parallelism of 50.  
> **Result:** Execution time dropped from 4 hours to 12 minutes.

**Implementation:**
1. Get Rows (SQL).
2. Apply to each (Settings > Concurrency > 50).
3. Upsert Row (Dataverse).

**Key learnings:**
- Ensure the target system (Dataverse) can handle 50 concurrent requests.
- Monitor the "Service Protection Limits" of the connectors involved.

## Quick Reference

### Concurrency Expressions & Settings

```javascript
// Note: Concurrency is a UI/Metadata setting, not an expression.
// However, to avoid variables in parallel, use:
union(variables('Array1'), variables('Array2')) // Combine results
xpath(xml(json(concat('{"root":{"item":', variables('Items'), '}}'))), 'sum(//Price)') // Summing without variables
```

### Related Features

| Feature | Purpose | Key Parameter |
|-----------|-----------|-----------------|
| **Split On** | Trigger-level concurrency | Trigger Settings |
| **Child Flows** | Offload parallel tasks | Run Child Flow |
| **Batching** | Grouping requests | Batch Size |

## Practice

**Exercise 1:** Create a flow that simulates a race condition. Initialize an integer variable to 0. Create an array of 100 items. Use an "Apply to each" with concurrency set to 50 to increment that variable by 1 for every item. Observe the output.

<details>
<summary>Hint</summary>

The final value will likely be less than 100 (e.g., 64 or 72) because multiple iterations are trying to update the variable at the same time.

</details>

<details>
<summary>Solution</summary>

1. **Initialize Variable**: `count` = 0.
2. **Compose**: `[1, 2, 3 ... 100]` (or use `range(1, 100)`).
3. **Apply to each**:
   - **Settings**: Concurrency On, Degree = 50.
   - **Action**: Increment variable `count` by 1.
4. **Final Action**: Send email with `count`.

**Key points:**
```javascript
// The result is non-deterministic. 
// To fix, change Concurrency to 1 or use the sum() pattern.
```

</details>

## Troubleshooting Guide

> [!CAUTION]
> **Common Errors:**

| Error | Cause | Fix |
|-------|-------|-----|
| **429 Too Many Requests** | Degree of parallelism is higher than the connector's limit. | Reduce the Concurrency slider (e.g., from 50 to 20). |
| **Inconsistent Variable Values** | Race condition inside a parallel loop. | Use Data Operations (Compose/Select) instead of Variables. |
| **Flow hangs/Slows down** | Nested loops with high concurrency exhausting resources. | Flatten the logic or move inner loops to Child Flows. |

## Tags
#architecture #performance #concurrency #parallel-processing #optimization

---