# Power Automate Interview Prep Template

**Topic:** [98. Restarting Logic via Child Flows](4. Control Flow Actions/Chapter 4 - Flow Lifecycle and Parallelism/98. Restarting Logic via Child Flows.md)

**Last Updated:** 2024-05-24  
**Confidence:** ðŸŸ¢ Solid  
**Category:** Patterns | Architecture

## What Is It?

Restarting logic via child flows is an architectural pattern where a parent flow invokes a secondary "child" flow to perform a specific task, allowing the parent to evaluate the result and potentially re-trigger the child flow to "restart" the logic if specific conditions or errors occur.

**Why It Matters:**  
Power Automate has a hard nesting limit of 8 levels and a 30-day run duration limit. By offloading complex or repetitive logic to child flows, developers can bypass nesting constraints, handle transient errors more gracefully, and create "infinite" loops (state machines) that don't exceed the execution limits of a single flow run.

## Core Concepts

- **Parent Flow** - The primary orchestrator that contains the main business logic and decides when to call or "restart" the subprocess.
- **Child Flow** - A solution-aware flow triggered by the "Manually trigger a flow" action that performs a discrete unit of work and returns a response.
- **Solution-Awareness** - A mandatory requirement; child flows must reside within a Power Platform Solution to be callable via the "Run a Child Flow" action.
- **Encapsulation** - The practice of isolating complex logic within the child flow so the parent only cares about the input parameters and the final output status.

## Implementation

### Basic Setup

**Run a Child Flow Action:**

```json
{
    "inputs": {
        "flowId": "GUID-OF-CHILD-FLOW",
        "inputs": {
            "RecordID": "@triggerOutputs()?['body/ID']",
            "RetryCount": 1
        }
    },
    "method": "POST",
    "path": "/flows/GUID/runs"
}
```

> [!TIP]
> Always use the "Respond to a PowerApp or flow" action at the end of your child flow. This ensures the parent flow waits for the child to complete and receives a structured output to determine if a "restart" is necessary.

### Advanced Configuration

To implement a "Restart" loop, use a **Do Until** loop in the parent flow that monitors a "Status" variable returned by the child flow.

```javascript
// Expression to check if the child flow requested a restart
// Used inside a Do Until condition
@equals(variables('ChildFlowStatus'), 'Restart')
```

> [!WARNING]
> If you create a logic where a child flow calls itself or the parent calls the child indefinitely, you may hit the "Action per minute" or "Concurrent run" limits. Always include a "Max Retry" counter to prevent infinite execution loops.

## Common Patterns

### Pattern 1: The "Clean State" Retry

```
Parent Flow
â””â”€â”€ Initialize RetryVariable = 0
â””â”€â”€ Do Until (RetryVariable > 3 OR Success == true)
    â””â”€â”€ Run Child Flow (Pass RetryVariable)
    â””â”€â”€ If Child Returns "Error"
        â””â”€â”€ Increment RetryVariable
    â””â”€â”€ Else
        â””â”€â”€ Set Success == true
```

This pattern is used when a specific action (like a premium API call) is flaky. Instead of a standard retry policy, the child flow provides a "clean slate" for every attempt.

### Pattern 2: The State Machine (Recursive Logic)

```
Parent Flow (Orchestrator)
â””â”€â”€ Run Child Flow (Process Batch)
    â””â”€â”€ Child returns "RemainingItems: 50"
â””â”€â”€ If RemainingItems > 0
    â””â”€â”€ Parent "Restarts" logic by looping back
```

This is used for processing large datasets that exceed the 30-day limit or the 100k action limit of a single flow run.

## Performance & Limits

> [!IMPORTANT]
> **Execution Limits:**
> - **Nesting:** You cannot call a child flow from another child flow beyond 8 levels deep.
> - **Licensing:** The "Run a Child Flow" action requires a Per User or Per Flow license (Premium).
> - **Connections:** Child flows must use "Embedded connections" or be shared with the parent flow's owner to run successfully.

**Optimization Tips:**
- Pass only the necessary IDs to the child flow, rather than large JSON objects, to reduce payload overhead.
- Use "Run-only users" settings in the child flow to ensure it runs under a specific Service Account context.
- Implement a `Terminate` action in the child flow for early exits to save action executions.

**When NOT to use:**
- For simple logic that can be handled by a standard "Retry Policy" on a single action.
- When low latency is critical; calling a child flow adds 1â€“3 seconds of overhead for the trigger handshake.

## Interview Questions

### Beginner

**Q:** What are the two main requirements for creating a Child Flow in Power Automate?

<details>
<summary>Answer</summary>

1. Both the Parent and Child flows must be located inside a **Solution**.
2. The Child flow must start with a **Manual Trigger** (Power Apps or Flow) and must contain a **Response** action (Respond to a PowerApp or flow).

</details>

### Intermediate

**Q:** How do you handle a scenario where a Child Flow fails due to a timeout, and you want the Parent Flow to "restart" it?

<details>
<summary>Approach</summary>

**Solution:**
Wrap the "Run a Child Flow" action in a **Scope**. Set the "Configure Run After" of the subsequent action to run only if the Scope has failed or timed out. Inside that "Failure" path, increment a retry counter and loop back using a "Do Until."

```json
{
  "runAfter": {
    "Scope_ChildFlow": ["Failed", "TimedOut"]
  }
}
```

> [!TIP]
> Ensure the Child Flow has its own internal error handling so it can return a "Failure" status code instead of just crashing, which makes the Parent Flow logic much cleaner.

**Follow-up they'll ask:** "What happens to the Parent Flow if the Child Flow runs for more than 30 days?"  
**Answer:** The Parent Flow will time out. A single action (including Run Child Flow) cannot exceed the parent's timeout limit, which is typically 30 days.

</details>

### Advanced

**Q:** Describe how to architect a "Recursive" flow structure using Child Flows to process 100,000 SharePoint items without hitting the 30-day or action limits.

<details>
<summary>Solution</summary>

**Architecture:**

1. **Parent Flow:** Acts as a "Queue Manager." It fetches a small batch (e.g., 100 items).
2. **Child Flow:** Processes the 100 items.
3. **Looping Logic:** The Parent Flow uses a "Do Until" loop. It calls the Child Flow, waits for completion, and then checks if there are more items in the SharePoint list.
4. **State Persistence:** If the Parent Flow approaches the 30-day limit, it saves the "Last Processed ID" to a database/list and triggers a *new* instance of itself before terminating.

**Key considerations:**

```javascript
// Use a 'Top' filter in the Get Items action
// Filter: ID gt 'LastProcessedID'
```

**Trade-offs to discuss:**
- **Option A (Single Flow):** Easier to build but will fail on large datasets or long durations.
- **Option B (Child Flows):** Highly scalable and modular, but consumes more API requests and requires Premium licensing.

</details>

## Comparison Table

| Feature | Standard Retry Policy | Child Flow Restart |
|----------|-----------|-----------|
| **Complexity** | Low (Toggle setting) | High (Requires Solution/Loop) |
| **Max Retries** | 90 | Unlimited (via Do Until) |
| **Logic Reset** | Retries same action | Can run entirely different logic |
| **Use Case** | Transient Network Errors | Business Logic Failures / Timeouts |

## Real Example

> [!NOTE]
> **Problem:** An ERP integration flow frequently failed because the target system was offline for maintenance every night, exceeding the standard 4-patch retry window.  
> **Solution:** The logic was moved to a Child Flow. The Parent Flow was configured to call the Child Flow. If the Child returned a "System Offline" status, the Parent would wait 1 hour and "restart" the Child Flow.  
> **Result:** 100% success rate for overnight batches; zero manual restarts required by the IT team.

**Implementation:**
```
Parent:
- Do Until Status == 'Success'
  - Run Child Flow
  - If Child Output == 'Offline'
    - Delay 60 minutes
  - Else
    - Set Status = 'Success'
```

**Key learnings:**
- Always pass a "RetryCount" to the child so it can log how many attempts were made.
- Use the "Delay" action strategically to avoid hammering the target system.

## Quick Reference

### Child Flow Requirements Checklist

- [ ] Flow is inside a Solution.
- [ ] Trigger is "Manually trigger a flow".
- [ ] Contains "Respond to a PowerApp or flow" action.
- [ ] Connections are set to "Use this connection" (Embedded) in the Run-only users settings.

## Practice

**Exercise 1:** Create a pattern where a Parent Flow calls a Child Flow to validate an Invoice. If the Child Flow finds the Invoice is "Pending," the Parent should wait 5 minutes and restart the Child Flow logic. Limit this to 3 attempts.

<details>
<summary>Hint</summary>

Use an Integer variable for `AttemptCount` and a Do Until loop that checks if `AttemptCount` is equal to 3 OR the `InvoiceStatus` is "Approved."

</details>

<details>
<summary>Solution</summary>

1. **Parent:** Initialize `varCount` = 0.
2. **Parent:** Initialize `varStatus` = "Pending".
3. **Parent:** Do Until `varCount` == 3 OR `varStatus` == "Approved".
4. **Inside Loop:** Run Child Flow (Pass InvoiceID).
5. **Inside Loop:** Set `varStatus` = Child Flow Output `Status`.
6. **Inside Loop:** Increment `varCount` by 1.
7. **Inside Loop:** If `varStatus` != "Approved", Delay 5 minutes.

**Key points:**
```javascript
// Do Until Condition
@or(equals(variables('varCount'), 3), equals(variables('varStatus'), 'Approved'))
```

</details>

## Troubleshooting Guide

> [!CAUTION]
> **Common Errors:**

| Error | Cause | Fix |
|-------|-------|-----|
| `The workflow... is not a child workflow.` | The child flow is missing the "Respond to a PowerApp or flow" action. | Add a Response action at the end of the child flow. |
| `Update the 'Run only users' property.` | The child flow is using "Provided by run-only user" for connections. | Go to the Child Flow's details page, click Edit on "Run only users," and change connections to "Use this connection." |
| `Flow not found in Solution.` | The Parent and Child are in different solutions or the Child is not in a solution at all. | Move both flows into the same Solution. |

## Tags
#architecture #patterns #child-flows #error-handling #scalability #solutions