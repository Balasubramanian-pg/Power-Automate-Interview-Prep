#data-transformation #power-query #functional-programming #m-language
**Last Reviewed**: 2023-10-27
**Confidence Level**: ðŸŸ¢ High

---

## **1. Topic Overview (The "What & Why")**
- **Definition**: The Current Item Reference is a special syntax or symbol (most commonly the underscore `_` in Power Query/M) used to represent the specific record or value currently being processed during an iterative operation.
- **Why It Matters**: It allows for dynamic, row-level logic within table transformations, enabling complex conditional columns, filtering, and nested calculations without explicitly naming every variable.
- **Common Interview Angle**: "How do you reference the entire current row in a custom function within a Power Query transformation?" or "Explain the scope of the underscore operator."

## **2. Core Concepts (The Foundation)**
- **The Iterator**: The function or process that moves through a collection (e.g., `Table.AddColumn`, `Table.SelectRows`).
- **The Placeholder (`_`)**: An implicit variable that holds the "current state" of the data as the iterator passes through it. Think of it as a **"You Are Here"** sign on a map.
- **Row Context**: The environment where the Current Item Reference exists; it only has meaning *inside* the function that called it.
- **How They Relate**: The **Iterator** creates a **Row Context**, and the **Current Item Reference** provides the handle to grab data from that specific context.

## **3. Technical Deep Dive (The Meat)**

### **A. Syntax/Implementation (Power Query / M Example)**
```powerquery
// Adding a custom column that references the current row
Table.AddColumn(
    Source, 
    "TotalMarkup", 
    each _[Price] * 1.2  // '_' represents the current record (row)
)

// Using the reference to pass the entire row to a function
Table.AddColumn(
    Source, 
    "Validation", 
    each MyCustomFunction(_) // Passes the whole record, not just one cell
)
```

### **B. Common Patterns**
- **Pattern 1: Record Access**: Using `_[ColumnName]` to access a specific field in the current row.
- **Pattern 2: Filtering Collections**: Using `Table.SelectRows(OtherTable, (inner) => inner[ID] = _[ID])`. Here, `_` refers to the outer table's current row, while `inner` is an explicit reference to the inner table's row.
- **Pattern 3: List Transformation**: In `List.Transform({1..5}, each _ * 2)`, the `_` represents the current number in the list.

### **C. Gotchas & Edge Cases**
- **Scope Shadowing**: If you nest iterators (an `each` inside an `each`), the `_` always refers to the *innermost* context. To access the outer row, you must use a named parameter (e.g., `(outer) => ...`).
- **Case Sensitivity**: In many languages (like M), field names accessed via the reference are case-sensitive (`_[Price]` vs `_[price]`).
- **Null Records**: If the current item is null, referencing a field (`_[Field]`) will throw an error unless handled with `try...otherwise`.

## **4. Performance Considerations**
- **Time Complexity**: O(n). Iterating through a table using a current item reference scales linearly with the number of rows.
- **Optimization Tips**: 
    1. Avoid calling heavy functions (like `Web.Contents`) inside an `each` block; it will execute for every single row.
    2. Buffer the table (`Table.Buffer`) if the current item reference is being used in a nested join or lookup to prevent re-reading the source.
- **When NOT to Use**: Do not use row-level references for operations that could be handled by vectorized "Merge" or "Group By" operations, which are often more engine-optimized.

## **5. Interview Question Bank**

### **Beginner Level**
- Q1: What does the underscore (`_`) represent in a Power Query `each` statement?
  - **Expected Answer**: It represents the current record or item being processed in the iteration.
  - **Follow-up**: Can you use it outside of an `each` statement? (No, it requires an iterative context).

### **Intermediate Level**
- Q2: How do you reference a column from an "outer" table when you are inside a nested `Table.AddColumn`?
  - **Approach**: You cannot use `_` for both. You must replace the `each` syntax with a formal function definition like `(outerRow) => ...`.
  - **Code**: `Table.AddColumn(Source, "New", (outer) => Table.SelectRows(Other, each [ID] = outer[ID]))`

### **Advanced Level**
- Q3: Explain the performance implications of using `_` in a `Table.SelectRows` function that references another table.
  - **Considerations**: This creates a "Nested Join" behavior.
  - **Solution**: If the inner table is large, this results in N*M complexity. The solution is to use `Table.Join` (Hash Join) instead of row-by-row filtering with a reference.

## **6. Comparison Table**
| Feature | Implicit Reference (`_`) | Explicit Parameter (`(x) =>`) |
|------------|------------|-------------|
| **Readability** | High for simple tasks | High for complex/nested tasks |
| **Nesting** | Causes scope conflicts | Resolves scope conflicts |
| **Flexibility** | Limited to current context | Can name multiple variables |
| **Best Use Case** | Quick column math | Nested lookups / Custom functions |

## **7. Real-World Example (The "Aha!" Moment)**
- **Problem**: I needed to create a "Running Total" column, but the standard UI didn't support it easily.
- **Solution**:
  ```powerquery
  Table.AddColumn(PreviousStep, "RunningTotal", (current) => 
      List.Sum(
          Table.SelectRows(PreviousStep, each [Index] <= current[Index])[Amount]
      )
  )
  ```
- **Outcome**: By using `current` as an explicit reference to the "Current Item," I could filter the *entire* table based on the index of the row currently being calculated.

## **8. Quick Reference Card**
- **The `each` Shortcut**: `each _[Col]` is shorthand for `(_) => _[Col]`.
- **Record Access**: `_` is a Record type.
- **List Access**: `_` is a Scalar type (Number, Text, etc.).
- **Decision Tree**:
    1. Is it a simple calculation? â†’ Use `each _`.
    2. Is there a loop inside a loop? â†’ Use `(outer) =>`.
    3. Is it a table-wide aggregation? â†’ Don't use row references; use `Group By`.

## **9. Practice Exercises**
- **Exercise 1**: Create a custom column that returns "High" if `_[Sales]` > 1000 and "Low" otherwise, using the current item reference.
  - Difficulty: Easy
  - Time: 5 min
  - **Solution**: `Table.AddColumn(Source, "Status", each if _[Sales] > 1000 then "High" else "Low")`

---

### **Mental Model Section**
**The Conveyor Belt**: Imagine a factory conveyor belt. Each box (row) passes under a scanner. The "Current Item Reference" is the box currently under the scanner. You can look inside that box, but you can't see the boxes that haven't arrived yet or those that have already passed, unless you have a "camera" (an explicit variable) looking at the whole belt.

### **Interviewer Perspective**
- **What they're testing**: Do you understand **Scope** and **Context**? Many developers copy-paste `each _` without knowing it's actually a syntactic sugar for a function.
- **Red Flags**: Using `each` for everything, even when nesting, which leads to logic errors where the code references the wrong "current" item.