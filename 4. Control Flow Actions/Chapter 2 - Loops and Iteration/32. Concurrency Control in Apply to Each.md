# [32. Concurrency Control in Apply to Each](4. Control Flow Actions/Chapter 2 - Loops and Iteration/32. Concurrency Control in Apply to Each.md)

#low-code #power-automate #logic-apps #performance-tuning
**Last Reviewed**: 2023-10-27
**Confidence Level**: ðŸŸ¢ High

---

## **1. Topic Overview (The "What & Why")**
- **Definition**: Concurrency Control is a configuration setting that determines whether loop iterations run one after another (sequentially) or simultaneously (in parallel), and specifically how many parallel "branches" are permitted.
- **Why It Matters**: By default, many orchestration engines process loops sequentially to ensure safety. Enabling concurrency can reduce the execution time of a 1,000-item loop from hours to minutes, but it introduces risks like race conditions and API throttling.
- **Common Interview Angle**: "How do you optimize a Power Automate flow that is running too slowly when processing a large array of data?"

## **2. Core Concepts (The Foundation)**
- **Degree of Parallelism**: The maximum number of iterations allowed to run at the exact same time (e.g., a degree of 20 means 20 items are processed concurrently).
- **Sequential Execution**: A degree of parallelism equal to 1. Each iteration must finish before the next begins.
- **Race Condition**: A logic error where multiple parallel iterations attempt to update the same resource (like a variable or a database row) simultaneously, leading to unpredictable results.
- **Throttling**: When the target system (e.g., SharePoint, SQL, Dataverse) rejects requests because the parallel loop is hitting it with too many calls at once.

## **3. Technical Deep Dive (The Meat)**

### **A. Implementation (Logic Apps/Power Automate Context)**
Concurrency is typically managed in the "Settings" menu of the `Apply to Each` action.

```json
// Underlying JSON definition of a loop with Concurrency Control enabled
"actions": {
    "Apply_to_each": {
        "type": "Foreach",
        "foreach": "@outputs('Get_items')?['body/value']",
        "runtimeConfiguration": {
            "concurrency": {
                "repetitions": 20 
            }
        },
        "actions": {
            "Send_an_email": { ... }
        }
    }
}
```

### **B. Common Patterns**
- **The Speed Demon (Max Parallelism)**: Setting concurrency to the maximum (usually 50) for independent tasks like sending notifications or generating independent files.
- **The Safe Sequence (Singleton)**: Explicitly turning Concurrency Control **ON** but setting the degree to **1**. This is used when the order of operations is critical (e.g., processing financial ledger entries).
- **The Balanced Batch**: Setting concurrency to a moderate number (e.g., 5-10) to improve speed without triggering the "429 Too Many Requests" error from the target API.

### **C. Gotchas & Edge Cases**
- **Variables are Global**: If you use `Set Variable` or `Increment Variable` inside a parallel loop, the result will be corrupted. All iterations share the same variable instance.
- **Order is Not Guaranteed**: In parallel mode, Item #10 might finish before Item #1. Never use concurrency if the sequence matters.
- **Nested Loops**: Enabling concurrency on an outer loop exponentially increases the load. If an outer loop has 10 concurrency and an inner loop has 10, you could potentially trigger 100 simultaneous actions.

## **4. Performance Considerations**
- **Time Complexity**: While the complexity remains $O(n)$, the *wall-clock time* is reduced to approximately $O(n/p)$, where $p$ is the degree of parallelism.
- **Optimization Tips**:
    1. **Avoid Variables**: Use `Compose` or data operations that don't rely on global state if you need parallelism.
    2. **Filter Early**: Use "Filter Array" or OData queries before the loop to reduce $n$, rather than using a "Condition" inside the loop.
- **When NOT to Use**: 
    - When updating a single Excel row or a specific file where file-locking occurs.
    - When the API of the destination system has strict rate limits.

## **5. Interview Question Bank**

### **Beginner Level**
- Q1: What is the default behavior of an "Apply to Each" loop?
  - **Expected Answer**: In Power Automate, it is sequential by default (though some versions/regions may vary, it is safest to assume sequential for data integrity).
  - **Follow-up**: How do you change it to run faster? (Settings -> Concurrency Control).

### **Intermediate Level**
- Q2: You have a loop that calculates a total sum using a variable. You turn on Concurrency (Degree: 20) to speed it up. What happens?
  - **Approach**: Identify the "Variable Race Condition."
  - **Answer**: The final sum will be incorrect. Multiple iterations will read, increment, and write to the same variable at the same time, overwriting each other's progress.

### **Advanced Level**
- Q3: How would you handle a scenario where you need parallel processing for speed, but you also need to aggregate data into a final report?
  - **Considerations**: Trade-off between speed and state management.
  - **Solution**: Use the parallel loop to perform the heavy lifting (e.g., API calls). Instead of updating a variable inside the loop, ensure the loop returns an array of results. After the loop finishes, use a `Select` or `Join` action outside the loop to aggregate the data.

## **6. Comparison Table**

| Feature | Sequential (Degree: 1) | Parallel (Degree: >1) |
|------------|------------|-------------|
| **Execution Speed** | Slow (Linear) | Fast (Concurrent) |
| **Variable Safety** | Safe | Unsafe (Race Conditions) |
| **Order of Execution** | Guaranteed (1, 2, 3...) | Random/Non-deterministic |
| **API Pressure** | Low | High (Risk of Throttling) |
| **Best For** | Financials, Logging | Emails, File conversion, Independent updates |

## **7. Real-World Example (The "Aha!" Moment)**
- **Problem**: A flow was processing 500 employee records to generate PDFs. It took 45 minutes, often timing out the trigger.
- **Solution**: Enabled Concurrency Control with a degree of 20. Replaced the "Set Variable" (used for the file name) with a "Compose" action inside the loop to avoid data corruption.
- **Outcome**: Execution time dropped to 3 minutes. The "Aha!" moment was realizing that `Compose` creates a scoped output unique to that iteration, whereas `Variables` are global to the entire flow.

## **8. Quick Reference Card**
- **Enable**: Settings -> Concurrency Control -> Toggle "On".
- **Max Degree**: 50 (Standard), 20 (some Logic App plans).
- **Golden Rule**: **No Variables in Parallel Loops.**
- **Decision Tree**:
    1. Does order matter? â†’ **Sequential**
    2. Are you using `Set Variable`? â†’ **Sequential** (or refactor to `Compose`)
    3. Is the target API slow/weak? â†’ **Sequential** or **Low Parallelism (2-5)**
    4. Everything else? â†’ **Parallel (20-50)**

## **9. Practice Exercises**
- **Exercise 1**: Create a flow that iterates through an array of 10 numbers. Inside the loop, add a 5-second delay. Compare the total run time with Concurrency OFF vs. Concurrency ON (Degree 10).
  - Difficulty: Easy
  - Time: 10 min
  - **Solution**: OFF will take ~50 seconds. ON will take ~5-7 seconds.

---

## **10. Revision Tags**
- `#power-automate` `#logic-apps` `#concurrency` `#performance`
- **Last Reviewed**: 2023-10-27
- **Confidence Level**: ðŸŸ¢

### **Mental Model Section**
**The Grocery Store Analogy**:
- **Sequential**: One cashier serving a line of 50 people. Itâ€™s slow, but the cashier knows exactly who is next and never gets confused.
- **Parallel**: 10 cashiers serving the same 50 people. Itâ€™s much faster, but if all 10 cashiers try to write in the *same* single paper ledger at the same time, they will scribble over each other's handwriting (Race Condition). To work in parallel, each cashier needs their own notepad (Compose/Scoped action).

### **Interviewer Perspective**
- **What they're really testing**: Do you understand the side effects of optimization? Anyone can toggle a switch to make things "fast," but a senior dev knows when that switch will break the data.
- **Red flags**: Suggesting parallelism for a process that requires strict chronological logging or failing to mention the danger of variables.