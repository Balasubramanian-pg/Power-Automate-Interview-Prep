# Power Automate Interview Prep Template

## Topic: 62. Sending Error Notifications

**Last Updated:** 2024-05-24  
**Confidence:** ðŸŸ¢ Solid  
**Category:** Patterns | Architecture

## What Is It?

Error notification is the automated process of alerting administrators or stakeholders when a flow fails, times out, or encounters a business logic exception, typically achieved by leveraging the "Configure Run After" setting and communication connectors.

**Why It Matters:**  
Without proactive error notifications, flows suffer from "silent failures" where critical business processes stop without notice. This leads to data inconsistencies, missed SLAs, and increased mean time to recovery (MTTR).

## Core Concepts

- **Configure Run After** - The fundamental setting on every action that determines whether it executes based on the previous action's status: Succeeded, Failed, Skipped, or Timed Out.
- **Scope Action** - A container used to group multiple actions together, allowing a single "Catch" block to handle errors for the entire group.
- **Workflow() Expression** - A system function used to extract metadata about the current flow run, such as the Environment ID, Flow ID, and Run ID, which are essential for deep-linking to the failed run.

## Implementation

### Basic Setup

**Configure Run After (JSON representation of logic):**

```json
{
  "runAfter": {
    "Previous_Action_Name": [
      "Failed",
      "TimedOut"
    ]
  }
}
```

> [!TIP]
> When sending an error email, always include a direct link to the flow run. You can construct this using: 
> `concat('https://make.powerautomate.com/environments/', workflow()?['tags']?['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']?['name'])`

### Advanced Configuration

**Extracting Error Details using `result()`:**

```javascript
// Use this expression in a Filter Array or Compose after a Scope fails
// It retrieves the error message from the failed actions inside 'Scope_Try'
result('Scope_Try')
```

> [!WARNING]
> If you use a "Catch" scope to send a notification, the flow run will technically be marked as **Succeeded** unless you explicitly end the flow with a "Terminate" action set to "Failed" after the notification is sent.

## Common Patterns

### Pattern 1: Try-Catch Scope

```
[Scope: Try]
    |-- Action 1
    |-- Action 2
[Scope: Catch] (Configured to Run After 'Try' has Failed or Timed Out)
    |-- Send Email/Teams Notification
    |-- Terminate (Status: Failed)
```

This is the industry-standard pattern for handling errors within a single flow. It ensures that if any action inside the "Try" block fails, the "Catch" block executes.

### Pattern 2: Centralized Error Handler (Parent-Child)

```
[Main Flow]
    |-- [Scope: Try]
    |-- [Scope: Catch]
          |-- Run Child Flow: "Generic Error Handler" (Passes Flow Name, Error, Run Link)
```

This pattern is used in enterprise environments to standardize how errors are logged (e.g., to a SQL database or Dataverse table) and notified across dozens of different flows.

## Performance & Limits

> [!IMPORTANT]
> **Connector Limits:**
> - **Office 365 Outlook:** 10,000 emails per 24 hours. Avoid putting error notifications inside high-frequency loops.
> - **Microsoft Teams:** Rate limits apply to "Post a message" actions; use "Post a message as the flow bot" for better stability.
> - **Message Size:** Email and Teams messages have character limits; do not attempt to send the entire raw JSON output of a large failed action.

**Optimization Tips:**
- Use **HTML Tables** in emails to format multiple errors if processing a batch.
- Use **Adaptive Cards** in Teams to provide "Retry" buttons directly within the notification.
- Use **Filter Array** on the `result('Scope_Name')` output to only include actions where `status` equals 'Failed'.

**When NOT to use:**
- Do not send notifications for "Expected Failures" (e.g., a "Get Record" failing because it's okay if the record doesn't exist). Use a Condition instead.
- Avoid sending notifications to shared mailboxes that are not monitored, as this defeats the purpose of alerting.

## Interview Questions

### Beginner

**Q:** How do you make an action run only if the previous action fails?

<details>
<summary>Answer</summary>

You use the **"Configure Run After"** setting. By clicking the three dots (...) on an action, you select "Configure run after" and check the box for **"has failed"** (and optionally "has timed out") while unchecking "is successful".

Example: If you have a "Send Email" action following a "Create File" action, you set the email to run only if "Create File" fails.

</details>

### Intermediate

**Q:** If you use a Scope to catch errors, the Flow Run history often shows "Succeeded" even if an error occurred. How do you fix this?

<details>
<summary>Approach</summary>

**Solution:**
This happens because the "Catch" block itself completes successfully, which "clears" the error state in the engine's view. To ensure the flow is marked as "Failed" in the run history for monitoring purposes, you must add a **Terminate** action at the end of your Catch block.

```json
{
  "type": "Terminate",
  "inputs": {
    "runStatus": "Failed",
    "runErrorCode": "CustomError",
    "runMessage": "The flow failed in the Try scope and was caught."
  }
}
```

> [!TIP]
> You can pass the actual error message from the failed action into the Terminate action's message field for better debugging.

**Follow-up they'll ask:** "What is the difference between 'Failed' and 'Timed Out' in Run After?"  
**Answer:** 'Failed' occurs when an API returns a 4xx or 5xx error or a required field is missing. 'Timed Out' occurs when an action exceeds its defined timeout limit (default is usually 30 days for approvals, but much shorter for HTTP requests).

</details>

### Advanced

**Q:** How would you implement a global error handling strategy for 50+ flows without duplicating the notification logic in every flow?

<details>
<summary>Solution</summary>

**Architecture:**

1.  **Child Flow (Error Handler):** Create a dedicated flow triggered by "When an HTTP request is received". It accepts JSON containing `FlowName`, `ErrorMessage`, `RunURL`, and `Environment`.
2.  **Logic:** This child flow handles the logic of sending Teams messages, emails, or logging to a DevOps dashboard.
3.  **Parent Flows:** Each of the 50 flows uses a standard Try/Catch scope. In the Catch block, they call the "Error Handler" child flow.

**Key considerations:**

```javascript
// Expression to get the error message from the first failed action in a scope
first(filter(result('Try_Scope'), x => equals(x['status'], 'Failed')))['error']['message']
```

**Trade-offs to discuss:**
- **Option A (Child Flow):** Pros: Single point of maintenance, consistent formatting. Cons: Adds an extra API call per failure; if the child flow fails, you lose the error.
- **Option B (Direct Logic):** Pros: No dependency on other flows. Cons: Maintenance nightmare if the notification recipient or branding changes.

</details>

## Comparison Table

| Notification Method | Speed | Rich Content | Best For |
|----------|-----------|-----------|---------------|
| **Email (Outlook)** | Medium | High (HTML) | Formal records, external stakeholders |
| **Microsoft Teams** | High | High (Adaptive Cards) | Internal IT/Dev teams, rapid response |
| **Push Notification** | High | Low | Individual mobile users |
| **Dataverse/SQL Log** | Low | Very High | Audit trails and Power BI reporting |

## Real Example

> [!NOTE]
> **Problem:** A critical ERP integration flow was failing intermittently due to SQL deadlocks, but the finance team only realized it days later when reports were empty.  
> **Solution:** Implemented a Try-Catch scope that sends an Adaptive Card to a "Production Support" Teams channel with the error details and a link to the run.  
> **Result:** MTTR (Mean Time to Recovery) dropped from 3 days to 15 minutes.

**Implementation:**
1. Scope "Process_Invoices" contains all logic.
2. Scope "Handle_Errors" configured to run if "Process_Invoices" fails.
3. Inside "Handle_Errors", a "Post adaptive card" action sends the `workflow().run.id` and the error message.

## Quick Reference

### Useful Expressions

```javascript
// Get Flow Run Link
concat('https://make.powerautomate.com/environments/', workflow()?['tags']?['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']?['name'])

// Get Error Message from a Scope (Advanced)
actions('Action_Name')?['error']?['message']

// Get the Environment Name
workflow()?['tags']?['environmentName']
```

## Practice

**Exercise 1:** Create a flow that intentionally fails (e.g., divide by zero in a Compose action) and sends a Teams message only when that failure occurs.

<details>
<summary>Hint</summary>

Use a "Compose" action with the expression `div(10, 0)`. Add a Teams action immediately after it, then change its "Configure Run After" settings.

</details>

<details>
<summary>Solution</summary>

1. Trigger: Manually trigger a flow.
2. Action: **Compose** (Inputs: `@div(1,0)`).
3. Action: **Post message in a chat or channel** (Teams).
4. Click `...` on the Teams action -> **Configure run after**.
5. Check **has failed** and uncheck **is successful**.
6. Add a **Terminate** action after the Teams message, set to **Failed**, to ensure the flow run is marked correctly.

**Key points:**
```javascript
// The flow will skip the Teams action unless the Compose action fails.
```

</details>

## Troubleshooting Guide

> [!CAUTION]
> **Common Errors:**

| Error | Cause | Fix |
|-------|-------|-----|
| **Notification not sent** | "Configure Run After" still set to "is successful". | Ensure "is successful" is unchecked and "has failed" is checked. |
| **Infinite Loop** | The error notification action itself is failing and triggering another error. | Ensure the notification action is outside the scope that might fail, or use a separate service. |
| **Missing Error Details** | Trying to access `body('Action')` of a failed action. | Use the `actions('Action_Name')?['error']` or `result('Scope')` syntax instead of `body()`. |

## Tags
#error-handling #governance #best-practices #try-catch #monitoring