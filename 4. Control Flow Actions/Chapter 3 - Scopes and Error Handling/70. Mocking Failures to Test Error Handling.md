# Power Automate Interview Prep Template

## Topic: 70. Mocking Failures to Test Error Handling

**Last Updated:** 2024-05-24  
**Confidence:** ðŸŸ¢ Solid  
**Category:** Patterns | Architecture

## What Is It?

Mocking failures is the intentional simulation of error states (such as API timeouts, authentication failures, or resource-not-found errors) within a flow to verify that error-handling logic, such as "Configure Run After" settings and Scope blocks, behaves as designed.

**Why It Matters:**  
In production environments, external systems (SQL, Dataverse, REST APIs) will inevitably fail. Without mocking these failures during development, developers cannot guarantee that their "Catch" blocks will trigger, that notifications will be sent, or that data integrity will be maintained through rollbacks.

## Core Concepts

- **Static Results (Mocking):** A built-in Power Automate feature that allows a user to define a "canned" response (Success or Failure) for a specific action, bypassing the actual execution of that action.
- **Configure Run After:** The engine's conditional logic that dictates whether an action should execute based on the status of the preceding action (Succeeded, Failed, Skipped, or Timed Out).
- **Scope-Based Error Handling:** The architectural pattern of grouping actions into "Try," "Catch," and "Finally" blocks using the Scope action to manage complex failure scenarios.

## Implementation

### Basic Setup

**Static Results Configuration:**

To mock a failure, you enable "Static Results" on an action's settings. This allows you to simulate specific HTTP status codes or error messages.

```json
{
  "outputs": {
    "statusCode": "404",
    "headers": {
      "Content-Type": "application/json"
    },
    "body": {
      "error": {
        "code": "ResourceNotFound",
        "message": "The requested item does not exist."
      }
    }
  },
  "status": "Failed"
}
```

> [!TIP]
> When using Static Results, the action will not actually call the underlying service. This is perfect for testing expensive API calls or actions that modify data without actually performing the operation.

### Advanced Configuration

**Manual Exception Throwing:**

Sometimes you need to mock a failure based on a condition that Static Results cannot cover. In these cases, you can use a "Compose" action with an intentional expression error or a "Terminate" action set to "Failed."

```javascript
// Intentional expression failure to trigger a Catch block
if(equals(variables('MockError'), true), div(1, 0), 'Success')
```

> [!WARNING]
> Always remember to disable Static Results before exporting your solution to production. Static Results are persisted in the flow definition and will cause the action to fail (or succeed) indefinitely until turned off.

## Common Patterns

### Pattern 1: The Try-Catch Scope

```
Scope: Try
    |-- Action: Get_Data (Mocked via Static Results)
Scope: Catch (Run After: Try has Failed)
    |-- Action: Send_Error_Notification
Scope: Finally (Run After: Catch has Succeeded OR Skipped)
    |-- Action: Log_Execution_Details
```

This is the standard pattern for robust flows. By mocking a failure in the "Try" scope, you can verify that the "Catch" scope executes and the "Finally" scope cleans up resources.

### Pattern 2: The Environment Variable Toggle

```
Condition: Is_Test_Mode?
    |-- Yes: Terminate (Status: Failed)
    |-- No: Proceed with Actual Action
```

Using an Environment Variable to toggle "Mock Mode" allows you to test error handling in UAT environments without modifying the flow's internal action settings.

## Performance & Limits

> [!IMPORTANT]
> **Mocking Constraints:**
> - Static Results are currently available for most built-in and standard connectors, but some custom connectors or specific triggers may not support them.
> - Static Results do not consume action execution limits in the same way a real call does, but the flow run still counts against your daily request limits.
> - Mocking is a design-time configuration; it cannot be toggled dynamically at runtime via expressions (use Pattern 2 for that).

**Optimization Tips:**
- Use Static Results to test "Timed Out" scenarios, which are otherwise very difficult to reproduce manually.
- Mock different error codes (401 vs 404 vs 500) to ensure your Catch block logic can differentiate between transient and permanent failures.
- Use the "Test" button with "Recent Trigger Data" after enabling a mock to quickly iterate on your error-handling logic.

**When NOT to use:**
- Do not use mocking for load testing; mocked actions do not reflect the actual latency of the target system.
- Do not use mocking if you need to test the actual data payload returned by a specific dynamic query.

## Interview Questions

### Beginner

**Q:** What is the "Configure Run After" setting, and how does it relate to testing failures?

<details>
<summary>Answer</summary>

"Configure Run After" allows you to define the condition under which an action executes. By default, actions run only if the previous action "Succeeded." To test error handling, you set an action (like a notification or logging step) to run only if the previous action (or Scope) has "Failed" or "Timed Out." Mocking failures is the process of forcing that failure to ensure the "Run After" logic works.

</details>

---

### Intermediate

**Q:** How would you simulate a "429 Too Many Requests" error from a connector that doesn't support Static Results?

<details>
<summary>Approach</summary>

**Solution:**
Since Static Results aren't available, you can use a "Terminate" action or a "Condition" block.

1. Create a variable called `varSimulateError`.
2. Insert a Condition: If `varSimulateError` is true.
3. In the "True" branch, add a **Terminate** action with Status = **Failed** and Code = **429**.
4. Set the subsequent error-handling actions to "Run After" the Condition block has "Failed."

> [!TIP]
> This approach is more flexible than Static Results because it can be controlled by external data or environment variables.

**Follow-up they'll ask:** "How do you ensure this doesn't happen in production?"  
**Answer:** Use an Environment Variable to control the toggle and include a check in your deployment pipeline to ensure the variable is set to 'False' in production.

</details>

---

### Advanced

**Q:** Describe a strategy for testing error handling in a long-running flow with multiple nested Scopes and asynchronous branches.

<details>
<summary>Solution</summary>

**Architecture:**

For complex flows, a "Mocking Layer" is required.

1. **Granular Mocking:** Use Static Results on specific actions within nested scopes to test "Partial Success" scenarios.
2. **Parallel Branch Testing:** Mock a failure in one branch of a parallel action to verify if the "Join" logic (e.g., a Compose action following the branches) handles the failure correctly using the `result()` expression.
3. **Result() Expression:** Use `result('Scope_Name')` in a Catch block to filter for specific error codes within the nested structure.

**Key considerations:**

```javascript
// Filter the result array to find the specific action that failed
filter(result('Try_Scope'), x => equals(x['status'], 'Failed'))
```

**Trade-offs to discuss:**
- **Static Results:** Easy to set up but manual and risky if forgotten.
- **Mocking via Logic (Conditions):** Safer for ALM (Application Lifecycle Management) but adds complexity and "clutter" to the flow diagram.

</details>

## Comparison Table

| Feature | Static Results | Terminate Action | Expression Failure |
|----------|-----------|-----------|---------------|
| **Setup Speed** | Very Fast | Moderate | Slow |
| **ALM Friendly** | No (Hardcoded) | Yes (via Variables) | Yes |
| **Simulates HTTP Codes** | Yes | Yes | No |
| **Best Use Case** | Quick dev-time testing | UAT/Integration testing | Testing specific logic gates |

## Real Example

> [!NOTE]
> **Problem:** A flow processing invoices was failing silently when the ERP API returned a 503 (Service Unavailable), leading to missed payments.  
> **Solution:** The developer enabled Static Results on the "HTTP - Submit Invoice" action, mocking a 503 error. This allowed them to build and test a "Retry" loop and an escalation email.  
> **Result:** The flow now successfully catches 503 errors, waits 10 minutes, and retries, reducing manual intervention by 95%.

## Quick Reference

### Run After Configuration

| Status | Description |
|-----------|-----------------|
| **Succeeded** | Previous action completed without error (Default). |
| **Failed** | Previous action encountered any error (Logic or Connection). |
| **Skipped** | Previous action was not executed (due to a condition). |
| **Timed Out** | Previous action exceeded its timeout limit (usually 30 days or custom). |

## Practice

**Exercise 1:** Create a flow that attempts to get a file from OneDrive. Mock a "File Not Found" (404) error and ensure the flow sends you an email instead of just failing.

<details>
<summary>Hint</summary>

Use the "Static Results" feature on the "Get file metadata" action. Set the status to "Failed" and the code to "404". Add an email action immediately after and change its "Configure Run After" to "has failed."

</details>

<details>
<summary>Solution</summary>

1. Add **OneDrive - Get file metadata**.
2. Go to Settings -> **Static Results (Preview)**.
3. Enable it, select **Failed**, and enter **404** as the status code.
4. Add **Office 365 Outlook - Send an email (V2)**.
5. Click the three dots on the email action -> **Configure run after**.
6. Uncheck "is successful" and check **"has failed"**.
7. Run the test. The email will send, and the flow will be marked as "Succeeded" (if the email is the last step).

</details>

## Troubleshooting Guide

> [!CAUTION]
> **Common Errors:**

| Error | Cause | Fix |
|-------|-------|-----|
| Flow still shows "Failed" even with Catch block | The Catch block itself failed or the final action didn't handle the status. | Ensure the last action in your Catch/Finally block succeeds, or use a Terminate (Succeeded) action. |
| Static Results not appearing | Connector does not support mocking. | Use the "Condition + Terminate" pattern instead. |
| "Static Results are enabled" warning | You left a mock active. | Open the action settings and toggle "Static Results" to Off before saving. |

## Tags
#error-handling #testing #static-results #governance #best-practices