# 55. Approval Response Handling

Canonical documentation for 55. Approval Response Handling. This document defines concepts, terminology, and standard usage.

## Purpose
Approval Response Handling exists to manage the transition of a system state based on an external decision. It addresses the critical gap between the solicitation of an approval and the final execution of the requested action. This topic ensures that decisions—whether provided by human actors or automated systems—are captured, validated, and processed in a manner that maintains data integrity, security, and auditability.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative.

## Scope
Clarify what is in scope and out of scope for this topic.

**In scope:**
*   **Ingestion:** The mechanism for receiving a decision from an external source.
*   **Validation:** Verification of the decision's authenticity, authority, and timeliness.
*   **State Management:** The logic governing how a request moves from "Pending" to a terminal state (e.g., Approved, Rejected).
*   **Post-Decision Logic:** The triggering of downstream actions based on the response.

**Out of scope:**
*   **Notification Delivery:** The specific transport methods (email, SMS, push) used to send the initial request.
*   **User Interface Design:** The visual layout of approval buttons or forms.
*   **Specific Vendor Implementations:** Proprietary logic specific to third-party workflow engines.

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| **Disposition** | The final decision rendered (e.g., Approved, Rejected, Returned). |
| **Approver** | The entity (human or system) authorized to provide a response. |
| **Response Payload** | The data packet containing the disposition, metadata, and optional comments. |
| **Idempotency** | The property where multiple identical responses result in the same system state without side effects. |
| **Stale Response** | A decision received after a request has expired or been superseded. |
| **Non-repudiation** | The assurance that the approver cannot deny having provided the response. |

## Core Concepts
### 1. Decision Integrity
The handler must ensure that the response received is exactly what the approver intended. This involves verifying that the response has not been tampered with during transit and that the identity of the responder matches the authorized approver.

### 2. State Finality
Once a response is processed and the system transitions to a terminal state (Approved or Rejected), the handler must prevent further modifications to that specific request instance. This ensures a clear and immutable audit trail.

### 3. Asynchronous Processing
Approval responses are inherently asynchronous. The system must be capable of maintaining state over indefinite periods, ranging from seconds to months, while waiting for a response payload.

## Standard Model
The standard model for Approval Response Handling follows a linear progression:

1.  **Ingestion:** The system receives a response via an API endpoint, webhook, or message queue.
2.  **Authentication & Authorization:** The handler verifies the responder's identity and checks if they possess the required permissions for the specific request.
3.  **Context Validation:** The handler checks if the request is still active (not expired, cancelled, or already completed).
4.  **Disposition Mapping:** The raw response (e.g., a "Yes" or a status code) is mapped to a formal system state.
5.  **State Transition:** The request record is updated to its new status.
6.  **Downstream Execution:** The handler triggers the actual work associated with the approval (e.g., provisioning a resource, releasing a payment).
7.  **Audit Logging:** Every step of the response handling is recorded with timestamps and actor metadata.

## Common Patterns
### The "Tokenized Link" Pattern
The response is handled via a unique, single-use cryptographic token embedded in a URL. This allows for "one-click" approvals while maintaining security without requiring the user to be actively logged into a session at the moment of response.

### The "Quorum" Pattern
The handler waits for multiple responses before reaching a final disposition. The logic defines whether the outcome is based on a majority, a consensus, or a specific number of "Approve" votes.

### The "Comment-Required" Rejection
A pattern where the handler enforces a validation rule: if the disposition is "Rejected," the response payload must contain a justification string.

## Anti-Patterns
*   **Silent Failures:** Receiving a response but failing to update the state or notify the requester when the processing fails due to a logic error.
*   **Over-Privileged Handlers:** Allowing the response handling service to execute downstream actions without verifying the original request's scope.
*   **Lack of Idempotency:** Allowing a user to click "Approve" twice, resulting in two separate downstream executions (e.g., two payments sent).
*   **Hard-Coded Logic:** Embedding specific business rules (e.g., "If amount > 1000, reject") directly into the response handler rather than a separate policy engine.

## Edge Cases
*   **Concurrent Responses:** Two authorized approvers respond simultaneously to a single-approver request. The handler must lock the record to ensure only the first response is processed.
*   **Approver De-provisioning:** An approver provides a response, but their account is deactivated before the handler finishes processing the downstream execution.
*   **Race Conditions:** A request is cancelled by the system at the exact millisecond an approver submits an "Approve" response.
*   **Partial Responses:** In multi-step approvals, receiving a response for Step 2 before Step 1 has been finalized.

## Related Topics
*   **32. Workflow State Machines:** The underlying logic that defines valid transitions.
*   **12. Identity and Access Management (IAM):** For verifying the authority of the responder.
*   **44. Audit Logging and Observability:** For recording the history of the response.
*   **61. Notification Orchestration:** The system that triggers the initial request for approval.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-01-16 | Initial AI-generated canonical documentation |