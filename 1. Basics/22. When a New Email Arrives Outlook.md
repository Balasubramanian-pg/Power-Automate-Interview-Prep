# 22. When a New Email Arrives Outlook

Canonical documentation for 22. When a New Email Arrives Outlook. This document defines concepts, terminology, and standard usage.

## Purpose
The "When a New Email Arrives" event serves as a foundational trigger in event-driven architectures and workflow automation. Its primary purpose is to monitor a specific messaging endpoint (a mailbox or folder) and initiate a downstream process immediately upon the receipt of a new communication. This mechanism eliminates the need for manual monitoring and enables real-time or near-real-time data processing, notification, and integration between email systems and external business applications.

> [!NOTE]
> This documentation is intended to be implementation-agnostic and authoritative, focusing on the logical behavior of the Outlook-based email trigger rather than specific low-code platform configurations.

## Scope
Clarify what is in scope and out of scope for this topic.

**In scope:**
* **Event Detection:** The mechanics of identifying a new message arrival via polling or webhooks.
* **Metadata Extraction:** The standard set of attributes available at the moment of arrival (e.g., Headers, Body, Attachments).
* **Filtering Logic:** The theoretical boundaries of server-side and client-side filtering during the trigger phase.
* **Security Context:** The permissions required to observe a mailbox.

**Out of scope:**
* **Vendor-specific UI:** Step-by-step guides for specific automation platforms (e.g., Power Automate, Zapier, Logic Apps).
* **Email Composition:** The process of sending or replying to emails.
* **Legacy Protocols:** Deep dives into POP3 or IMAP specificities, focusing instead on modern API-based interactions (e.g., Microsoft Graph).

## Definitions
Provide precise definitions for key terms.

| Term | Definition |
|------|------------|
| **Trigger** | An event that initiates a workflow or automated process. |
| **Webhook** | A push-based mechanism where the mail server notifies the subscriber of a new event. |
| **Polling** | A pull-based mechanism where the system periodically checks the server for new messages. |
| **Mailbox Folder** | A logical container within a mailbox (e.g., Inbox, Junk, Custom Folders) where the trigger is scoped. |
| **Metadata** | Data about the email (Sender, Timestamp, Subject) as opposed to the content itself. |
| **Service Principal** | An identity used by an application to access mail resources without a specific user's interactive login. |

## Core Concepts
### Event-Driven Architecture
The arrival of an email is treated as a discrete event. In a modern ecosystem, this is typically handled by a subscription model. The automation engine subscribes to a "resource" (the mailbox), and the mail server emits a notification when the state of that resource changes (i.e., a new `message` object is created).

### State Persistence
To prevent duplicate processing, the system must maintain a "high-water mark" or a state record. This ensures that if the connection is interrupted, the system knows which emails have already been processed and which are "new" upon reconnection.

### Data Payload
Upon arrival, the trigger typically captures three layers of data:
1.  **Envelope Data:** Routing information (From, To, CC, BCC).
2.  **Content Data:** The message body (HTML or Plain Text) and Subject line.
3.  **Attachment Data:** Files or objects associated with the message, often requiring secondary calls to retrieve if they exceed certain size thresholds.

## Standard Model
The standard model for monitoring new emails follows a specific lifecycle:

1.  **Subscription/Connection:** The integration establishes a connection to the Outlook API using OAuth 2.0.
2.  **Scope Definition:** The trigger is constrained to a specific folder (defaulting to `Inbox`).
3.  **Filter Evaluation:** The server or the middleware evaluates the incoming message against pre-defined criteria (e.g., "Does the subject contain 'Invoice'?").
4.  **Event Emission:** If criteria are met, a JSON payload representing the email is passed to the next step in the workflow.
5.  **Acknowledgment:** The system marks the event as "handled" to prevent re-triggering.

## Common Patterns
*   **The Router Pattern:** A single "New Email" trigger monitors a mailbox and uses conditional logic to route data to different departments based on the sender's domain.
*   **The Attachment Processor:** The trigger is configured to fire only when an email contains an attachment, which is then stripped and uploaded to a cloud storage provider.
*   **The Sentiment Monitor:** Incoming emails are passed to a Natural Language Processing (NLP) engine immediately upon arrival to flag "High Priority" or "Angry" customers.

## Anti-Patterns
*   **The Infinite Loop:** Setting up a trigger that responds to an email by sending a new email to the same mailbox, which then triggers the process again.
*   **Over-Polling:** Setting a polling interval too high (e.g., every 1 second) on a mailbox with low volume, leading to unnecessary API consumption and potential rate-limiting.
*   **Broad Scoping:** Monitoring the "All Mail" or "Junk" folders without strict filters, leading to the processing of spam or irrelevant system notifications.
*   **Heavy Processing in Trigger:** Attempting to perform complex data transformations within the trigger logic itself rather than passing the raw data to a dedicated processing layer.

## Edge Cases
*   **Delayed Delivery:** Emails that are sent at 10:00 AM but, due to server delays, arrive at 10:15 AM. The system must decide whether to use the "Sent" time or "Received" time for logic.
*   **Inline vs. Actual Attachments:** Distinguishing between a file attachment and an image embedded in a signature.
*   **Shared Mailboxes:** Triggers behaving differently when monitoring a shared mailbox versus a primary user mailbox, particularly regarding permissions and "Read/Unread" status synchronization.
*   **Large Message Blobs:** Emails exceeding 25MB may fail to trigger or may require a "Claim Check" pattern where only a link to the content is provided.

## Related Topics
*   **OAuth 2.0 Authentication:** The standard protocol for securing the connection to the mailbox.
*   **Microsoft Graph API:** The underlying API surface for modern Outlook interactions.
*   **Webhooks and Subscriptions:** The technical implementation of push-based notifications.
*   **Rate Limiting and Throttling:** Understanding the constraints imposed by the mail server on frequent requests.

## Change Log
| Version | Date | Description |
|---------|------|-------------|
| 1.0 | 2026-01-16 | Initial AI-generated canonical documentation |