# 49. Custom Error Messages for Admins

## 1. Flow Overview
- **Flow Name**: Global Admin Exception Handler & Notification Service
- **Business Problem Statement**: Standard system error messages are often cryptic, lack business context, and are sent to end-users who cannot resolve them. Admins require specific technical metadata (Action Name, Error Code, Correlation ID, and Input Data) to perform rapid root cause analysis.
- **Business Impact / Value**: Reduces Mean Time to Repair (MTTR) by providing actionable debug information immediately. Prevents "alert fatigue" by formatting and filtering notifications, and ensures sensitive system details are shielded from end-users while being exposed to authorized administrators.
- **Trigger Type**: Instant (typically called as a Child Flow or via HTTP Request)
- **Trigger Source**: Parent Workflows / Logic Apps
- **Systems / Connectors Involved**: Microsoft Teams, Outlook 365, Dataverse (for logging), Power Automate Management Connector.
- **Expected Run Frequency**: Only on failure of production workflows.
- **Estimated Data Volume**: Low (Metadata-only payloads).

## 2. Trigger Design
- **Trigger Connector & Action**: Power Automate - "Manually trigger a flow" (Input Schema defined to receive Error Details).
- **Why This Trigger Was Chosen**: Using an Instant trigger allows this flow to act as a centralized, reusable "Function" that any other flow in the environment can call when an error occurs.
- **Trigger Conditions Used**: No.
- **Trigger Condition Logic**: N/A (Logic is handled in the Parent Flow's "Run After" configuration).
- **Polling vs Event-Based**: Event-Based (Triggered immediately upon failure of a parent process).
- **How Unnecessary Runs Are Avoided**: The flow is only invoked via the "Configure Run After" settings of a Scope or Action in the parent flow, ensuring it only executes when a `Failed`, `TimedOut`, or `Skipped` status is detected.

## 3. End-to-End Flow Narrative
The flow begins when a Parent Flow encounters an error within a "Try" scope. The Parent Flow's "Catch" scope invokes this Admin Notification flow, passing in the Workflow ID, Run ID, and the output of the `result()` expression.

Upon triggering, the flow parses the error JSON to extract the specific action that failed and the raw error message. It then uses a Switch statement to determine the severity based on the failed action's importance. The flow constructs a rich-text HTML table or a Teams Adaptive Card containing the Flow Name, Environment, Timestamp, Error Message, and a direct deep-link to the failed run.

Finally, the flow sends this formatted message to a dedicated Admin Teams Channel or IT Support email alias and logs the incident into a centralized Dataverse table for long-term trend analysis.

## 4. Key Actions and Connectors
Document only the actions that influence logic, performance, or reliability.

| Action Name | Connector | Purpose | Key Inputs | Key Outputs | Why This Action |
|------------|-----------|---------|------------|-------------|----------------|
| Parse Error JSON | Data Operations | Extracts specific error codes and messages from the parent flow's `result()` array. | `body('Trigger')` | `ErrorMessage`, `ActionName` | Allows for granular filtering of system noise vs. actual logic errors. |
| Get Flow | Power Automate Management | Retrieves the display name of the flow that failed. | `WorkflowID` | `FlowDisplayName` | IDs are not human-readable; admins need the Flow Name for context. |
| Compose Adaptive Card | Data Operations | Formats the error into a visual UI for Microsoft Teams. | JSON Schema | `CardBody` | Adaptive Cards allow for "one-click" buttons to open the failed run. |
| Post Message (V3) | Microsoft Teams | Delivers the alert to the Admin team. | `CardBody`, `ChannelID` | `MessageID` | Real-time notification is superior to email for critical production failures. |

## 5. Control Logic and Flow Structure
- **Conditions Used**: Used to check if the error is a "Known Exception" (e.g., a 404 that is expected) to avoid spamming admins.
- **Switch Statements**: Used to route notifications to different teams (e.g., Database errors go to the DBA team, API errors go to the Integration team).
- **Loops (Apply to each / Do until)**: Used to iterate through the `result()` array of the parent flow to find the *first* action that failed.
- **Nested Loops**: No.
- **Parallel Branches**: Used to simultaneously log the error to a database and send a real-time Teams alert.
- **Scope Usage**: "Try-Catch-Finally" blocks are used within this flow itself to ensure that if the notification system fails, it doesn't create an infinite loop of errors.

## 6. Error Handling and Monitoring
- **Anticipated Failure Scenarios**: Teams service downtime, invalid JSON passed from parent, or expired connection references.
- **Try Scope Logic**: Contains the parsing and message construction logic.
- **Catch Scope Logic**: If the notification fails, a secondary "fail-safe" email is sent using a different connector (e.g., Mail instead of Outlook).
- **Finally Scope Logic**: Updates a "Heartbeat" log to confirm the error handler finished execution.
- **Run After Configuration**: The "Catch" scope is set to run only if the "Try" scope fails.
- **Failure Notification Method**: Secondary email to a global "Break-glass" account.
- **Logging Strategy**: Every execution is logged in a "Flow Error Log" Dataverse table including the `workflow()` object.
- **How to Debug a Failed Run**: Review the "Inputs" of the trigger to see the raw JSON passed from the parent flow.

## 7. Data Handling and Expressions
- **Variables Used**: `varErrorDetails` (String), `varSeverity` (String).
- **Key Expressions**: 
    - `result('Try_Scope')`: To get the status of all actions in the parent scope.
    - `concat('https://make.powerautomate.com/environments/', workflow()?['tags']?['environmentName'], '/flows/', workflow()?['name'], '/runs/', workflow()?['run']?['name'])`: To generate a deep-link to the specific failed run.
- **Data Operations (Select / Filter array / Compose)**: `Filter Array` is used on the `result()` output to isolate only actions where `status == 'Failed'`.
- **Why Expressions Were Used Instead of Actions**: Expressions like `first()` and `filter()` are used to avoid unnecessary "Apply to Each" loops, significantly improving performance.

## 8. Performance and Scalability
- **Known Bottlenecks**: The "Get Flow" action can be slow if the Management API is under heavy load.
- **Loop Optimization Strategy**: Using `Filter Array` instead of a loop with a condition inside.
- **Pagination Handling**: N/A (Error payloads are typically small).
- **Concurrency Control**: Set to 50 to handle simultaneous failures of multiple flows during a system outage.
- **What Breaks at Higher Data Volumes**: If 1,000 flows fail at once, Teams may rate-limit the connector.
- **Redesign Approach for Scale**: For high-volume environments, push errors to Azure Application Insights or Log Analytics instead of sending individual Teams messages.

## 9. Security and Governance
- **Connection Type (Personal / Service Account)**: Service Account (e.g., `svc_powerplatform@company.com`).
- **Environment Strategy**: Deployed as a "Global Solution" in the Production environment.
- **Secrets Handling**: Any API keys or connection strings are retrieved from Azure Key Vault.
- **DLP Considerations**: Ensure the "HTTP" and "Teams" connectors are in the same data group (Business vs. Non-Business).
- **Access Control Notes**: Only members of the "Environment Admin" role can view the run history of this flow.

## 10. Testing and Validation
- **Test Scenarios Covered**: 
    - Forced failure in Parent Flow (Divide by zero).
    - Timeout failure (Setting a 1-minute timeout on an action).
    - Unauthorized access failure (401/403).
- **Edge Cases Considered**: What happens if the error message contains special characters that break JSON parsing? (Handled via `base64()` encoding/decoding).
- **Failure Testing**: Manually disabling the Teams connector to ensure the "Fail-safe" email logic triggers.
- **Rerun / Recovery Strategy**: Admins can fix the underlying data issue and use the "Resubmit" button on the *Parent* flow run.

## 11. Interview Question Mapping
- **Explain This Flow in 2â€“3 Minutes**: "I built a centralized error handling framework that intercepts failures in production flows. Instead of generic 'Flow Failed' emails, it parses the specific action failure, generates a deep-link to the exact run, and posts an Adaptive Card to our Admin Teams channel. This reduced our troubleshooting time by 60% because admins no longer have to hunt for the error source."
- **How Failures Are Handled**: "The flow uses a Try-Catch pattern. If the primary notification via Teams fails, it falls back to a standard SMTP mailer to ensure no critical error goes unnoticed."
- **How Performance Is Optimized**: "I avoided 'Apply to Each' loops by using the `Filter Array` data operation to instantly isolate the failed action from the `result()` function output."
- **One Trade-Off Made**: "I chose to use a Child Flow pattern. While it adds a slight dependency, the trade-off is worth it for the maintainability of having a single place to update our error notification logic across 50+ flows."

## 12. Lessons Learned
- **Initial Issues**: Initially, the flow sent an email for *every* failure, which led to admins ignoring them.
- **Improvements Made**: Added logic to "De-duplicate" errors so that if the same flow fails 100 times in an hour, only the first and last failures are alerted, with a count in between.
- **What I Would Do Differently Now**: I would integrate this with Azure Log Analytics from the start to provide long-term dashboards on flow reliability trends.

> [!IMPORTANT]
> Always ensure the Service Account used for notifications has "Send As" permissions if using Outlook, or is a member of the private Teams channel.

> [!TIP]
> Use the `workflow()` expression to dynamically grab the Environment Name so the same flow can be deployed across Dev, Test, and Prod without manual configuration.